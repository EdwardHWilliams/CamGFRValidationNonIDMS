---
title: 'Supplement for: Multicentre validation of the CamGFR model for estimated glomerular
  filtration rate'
# author: "Edward H. Williams"
# date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
    \newcommand{\beginsupplement}{\setcounter{table}{0}  
    \renewcommand{\thetable}{S\arabic{table}} 
    \setcounter{figure}{0} 
    \renewcommand{\thefigure}{S\arabic{figure}}}
    \usepackage{breqn}
    \usepackage{biblatex}
    \usepackage{graphicx}
    \usepackage{textgreek}
output:
  pdf_document:
    # citation_package: natbib
    fig_caption: yes
    keep_tex: yes
    latex_engine: xelatex
  word_document: default
  html_document:
    df_print: paged
affiliation: University of Cambridge
editor_options:
  chunk_output_type: console
endnote: no
mainfont: Arial
fontsize: 11pt
geometry: margin=1in
keywords: Glomerular Filtration Rate, CamGFR, CKD-EPI, Carboplatin
bibliography: /Users/willia01/Documents/Mendeley_Desktop/Bibtex/Validation_1_References.bib
csl: /Users/willia01/Documents/Mendeley_Desktop/Bibtex/american-medical-association.csl
abstract: This document is the supplemental file for the paper "Multicentre validation of the CamGFR model for estimated glomerular filtration rate" and provides additional methods, results, figures and tables. The .Rmd file format contains the R code used for this manuscript. Table S5 contains all results, but for space reasons only Table S5a is included in this document. The entire Table S5 and all R files are available on request and deposited at [github.com/EdwardHWilliams/CamGFRValidationNonIDMS](https://github.com/EdwardHWilliams/CamGFRValidationNonIDMS).
---

\beginsupplement


```{r file_setup, include=F}
fig_export_dir = "/Users/willia01/Documents/Projects/GFR/GFR_paper/1_Validation_NonIDMS_paper/Figures_tables/"
# knitr::opts_chunk$set(cache = T, echo = F)
```

```{r load_librarys_and_Rfiles, include = F}
library(knitr)
library(kableExtra)
library(tidyverse)
library(ggpubr)
library(openxlsx)
library(cowplot)
library(grid)
library(ggthemes)

# Load the data and helper function
source("Clean_data.R")
source("ggplot_functions.R")
source("Functions_for_stat_tables.R")
source("Bootstrap_CI_functions.R")


function(x, y)
  sqrt(mean( (x - y)^2, na.rm = TRUE))
```

# Data description and filtering

Raw data that were received from the seven different centres, which are identified by their location (Cambridge, Edinburgh, London-Barts, Manchester, Melbourne, Southampton and Wales). Data were individually processed and cleaned prior to being used for analyses. This step involved exploring the data for manual transcription errors such as the height and weight variable being swapped and removing unrealistic values for some variables. During this process all data were converted to the same units to enable data pooling and analyses across the different centres and subgroup categories.

Next, patients with data outside the inclusion criteria were removed. The inclusion criteria were:
\begin{itemize}
\item Serum creatinine value between 18 \textmu mol/L (0.2 mg/dL) and 400 \textmu mol/L (4.5 mg/dL)
\item Age of 18 years or older
\item Creatinine and GFR measurements performed within 30 days of each other 
\item If a patient had multiple GFR measurements, only the first one would be included
\end{itemize}
The creatinine cut-off values were chosen because the lower value is the typical detection threshold on the measurement assay and the upper value is 3-4 times the upper limit of normal in most centres, thus corresponding to a value at which most clinicians would consider kidney function severely impaired. The 30 days was selected to minimise errors caused by changing creatinine. We confirmed that a 30 day window before and after mGFR was reasonable for creatinine measurements by comparing accuracy in seven different windows relating to the difference in measurement dates. We detected no change in accuracy (Figure \ref{fig:performace_date_diff}). 

All creatinine data were either measured using a non-IDMS traceable measurement or the measurement procedure was not known, but likely to be non-IDMS traceable due to the dates of measurements. Table \ref{tab:creat_info} summaries the information on the creatinine measurement for each centre.

\begin{table}[H]
\caption{Creatinine methods used at each centre}
\begin{tabular}{|l|l|l|}
\hline
\textbf{Centre} & \textbf{Date range}                                                           & \textbf{Creatinine measurement method}                                                                                                                                                                                               \\ \hline 

Cambridge       & 2013                                                                          & Dimension RxL compensated Jaffe, not IDMS-traceable                                                                                                                                                                                                                  \\ \hline
Edinburgh       & 2011 - 2017                                                                   & \begin{tabular}[c]{@{}l@{}}An Abbott Architect assay using the Jaffe method;  \\ 
not IDMS-traceable \end{tabular}                                                                                             \\ \hline
London-Barts    & 2010 - 2017                                                                   & Unknown method; IDMS usage not known                                                                                                                                                                                                                  \\ \hline
Manchester      & 2012 - 2016                                                                   & \begin{tabular}[c]{@{}l@{}} Jaffe method  using O’Leary reagent; \\
not IDMS-traceable  \end{tabular}                                                                                                                                                          \\ \hline
Melbourne       & 2000 - 2005                                                                   & Jaffe method; not IDMS-traceable \\ \hline
Southampton     & 1999 - 2012                                                                   & \begin{tabular}[c]{@{}l@{}}Jaffe method; given the date range, most, \\
if not all, not IDMS-traceable\end{tabular}                                                                \\ \hline
Wales           & \begin{tabular}[c]{@{}l@{}}2005 - 2011, \\ not all dates\\ known\end{tabular} & \begin{tabular}[c]{@{}l@{}}Different centres used either Jaffe or enzymatic methods; \\ 
IDMS usage not known\end{tabular} \\ \hline
\end{tabular}
\label{tab:creat_info}
\end{table}


```{r seting_up_datsets, eval = T, include = F}
# All data that is used at somepoint in this analysis
New_nonIDMS_data <- All_data %>%
  mutate(BSA = SufA) %>%
  filter(Age >= 18) %>% # removing any patients under 18 years old
  # filter(GFR_index == 1) %>% # keeping only a patients first GFR measurment
  group_by(PatientID) %>%
  filter(Creatinine_type != "IDMS") %>%
  mutate(Date_GFR_diff = c(NA, diff(Date_GFR))) %>%
  ungroup() %>%
  # filter(Date_GFR_diff > 365 | is.na(Date_GFR_diff)) %>%
  filter(GFR_index == 1) %>%
  filter(Creat*88.4 > 18) %>% # remove creatinien values less than 18 as some centres do not report creatinine values lwer than this value
  filter(Creat*88.4 < 400) %>% # removed as
  filter(!Centre %in% c("Adden_old", "Glasgow")) %>% # remove data from previous study 
  mutate(Centre = factor(Centre, 
                         labels = c("Manchester", "Edinburgh", "Cambridge", 
                                    "Southampton", "Melbourne", "Wales",
                                    "London-Barts"),
                         levels = c("Manchester", "Edinburgh", "Adden_new",  
                                    "Southampton", "Melbourne", "SW", "Barts"))) %>%
  mutate(Centre = as.character(Centre), Ethnicity = as.character(Ethnicity)) %>%
  mutate(Ethnicity_black = ifelse(is.na(Ethnicity), 0, Ethnicity == "Black")) %>%
  mutate(Ethnicity = ifelse(Ethnicity == "Unknown", NA, Ethnicity)) %>%
  mutate(Diagnosis = ifelse(Diagnosis == "Seminoma", "GCT", Diagnosis)) %>%
  mutate(Patient_type = ifelse(Patient_type %in% c("Donor", "Misc"), "Non-cancer",
                               Patient_type)) %>% 
  mutate(Patient_type = ifelse(Diagnosis == "Non-cancer", "Non-cancer", Patient_type)) %>%
  mutate(Diagnosis = ifelse(Diagnosis == "Non-cancer", "Unknown", Diagnosis)) %>%
  mutate(Ethnicity = ifelse(Ethnicity == "Mixed/Other", "Other", Ethnicity))
```


```{r creat_GFR_date_diff, cache = T, echo = F, warning=F, include=F}

GFR_creatinine_date_diff_plot <- 
  New_nonIDMS_data %>% 
  select(Date_GFR, Date_creat, Centre) %>%
  mutate(Date_diff = as.numeric(Date_GFR - Date_creat)) %>%
  filter(!is.na(Date_diff)) %>%
  select(Date_diff, Centre) %>%
  # table() %>%
  # as.data.frame() %>%
  ggplot(aes(x  = Date_diff,  fill = Centre)) +
  geom_bar() + 
  ggplot_theme() + 
  scale_fill_manual(values = tol5qualitative) + 
  xlab("GFR Date - Creatinine Date [days]")

date_diff = New_nonIDMS_data %>% 
  select(Date_GFR, Date_creat, Centre) %>%
  mutate(Date_diff = Date_GFR - Date_creat) %>%
  filter(!is.na(Date_diff)) %>%
  select(Date_diff) %>%
  table() 

date_diff_abs = New_nonIDMS_data %>% 
  select(Date_GFR, Date_creat, Centre) %>%
  mutate(Date_diff = Date_GFR - Date_creat) %>%
  filter(!is.na(Date_diff)) %>%
  pull(Date_diff) %>%
  abs() %>%
  table() 

abs_per = date_diff_abs/sum(date_diff_abs)*100
cumsum(abs_per) %>% as.data.frame()

```


```{r PLOT_date_diff, echo = F, include = T, fig.width=6, fig.height=3, fig.cap="\\label{fig:date_diff_barplot}Barplot of the time difference between GFR and serum creatinine measurements for each patient. A negative difference indicates that the serum creatinine was measured after the GFR. Some centres only reported time ranges for the creatinine, i.e. that it was measured within 30 days of GFR, and not specific dates. Data from these centres were not included for this barplot."}
GFR_creatinine_date_diff_plot
```

Figure \ref{fig:date_diff_barplot} shows the difference in time between the GFR and creatinine measurements days. Most patients had their creatinine measured on, or in, the week after the nuclear medicine GFR, with this being the case for all patients from Manchester. 

Table 1 in the main manuscript provides the number of patients in different categorical groups and the summary statistics for the continuous variables (GFR, age, serum creatinine, body surface area (BSA), height and weight) for all patients. Here we provide the summary statistics for patients split into different centres (Table \ref{tab:summary_centre}).

```{r data_characteristic_tables, cache = T, echo = F, warning=F}
# Msnuscript Table 1 a
Samples_per_centre <- New_nonIDMS_data %>%
  group_by(Centre) %>%
  summarise("Total" = length(GFR),
            "Solid tumour" = length(GFR[Patient_type == "Cancer"]),
            "Hematology" = length(GFR[Patient_type == "Haem"]),
            "Non-cancer" = length(GFR[Patient_type != "Haem" & Patient_type != "Cancer"]),
            "Female" = length(GFR[Sex == "F"]),
            "Repeat patients" = length(GFR[GFR_index > 1]), 
            "Race - Black" = sum(Ethnicity == "Black", na.rm = T)) %>%
  rbind(c("Total", sum(.$`Total`), sum(.$`Solid tumour`), sum(.$Hematology),
          sum(.$`Non-cancer`), sum(.$Female), sum(.$`Repeat patients`), sum(.$`Race - Black`)))

# Msnuscript Table 1 b
Summary_variables <- New_nonIDMS_data %>%
  mutate(Creatinine = Creat*88.4) %>%
  select("GFR [ml/min]" = GFR, "Creatinine [\u00B5mol/L]" = Creatinine, 
         "Creatinine [mg/dL]" = Creat,"Age [years]" = Age, 
         "Height [cm]" = Ht, "Weight [kg]" = Wt, "BSA [m\u00B2]" = BSA) %>%
  dplyr_summary(full_name = T) %>% as.data.frame() %>%
  select(5, 3, 4, 1, 6, 7, 2)



Centre_diagnosis_summary <- New_nonIDMS_data %>%
  group_by(Centre, Diagnosis) %>%
  summarise(n = n()) %>%
  spread(key = Centre, value = n) %>%
  replace(., is.na(.), 0) %>%
  mutate(Total = rowSums(select(., -Diagnosis))) %>%
  arrange(-Total)

Variable_summary_by_centre <- New_nonIDMS_data %>%
  mutate("Creatinine [\u00B5mol/L]" = Creat*88.4) %>%
  select("GFR [ml/min]" = GFR, "Creatinine [\u00B5mol/L]",
         "Age [years]" = Age, "Height [cm]" = Ht, "Weight [kg]" = Wt, 
         "BSA [m\u00B2]" = BSA, Centre) %>%
  split(f = .$Centre) %>%
  lapply(function(x) select(x, -Centre)) %>%
  lapply(FUN = dplyr_summary) %>%
  lapply(FUN = function(df){
    df %>% as.data.frame() %>% select(4, 3, 1, 6, 5, 2)
  }) 
# Variable_summary_by_centre %>%
#  lapply(FUN = function(df){
#    df %>% format(digits = 2, drop0trailing = TRUE) %>% t() %>% kable()
#  })


Variable_summary_by_patient_type <- New_nonIDMS_data %>%
  mutate("Creatinine [\u00B5mol/L]" = Creat*88.4) %>%
  select("GFR [ml/min]" = GFR, "Creatinine [\u00B5mol/L]",
         "Age [years]" = Age, "Height [cm]" = Ht, "Weight [kg]" = Wt, 
         "BSA [m\u00B2]" = BSA, Patient_type) %>%
  mutate(Patient_type = ifelse(Patient_type %in% c("Misc","Donor"), "Non_cancer", Patient_type)) %>%
  split(f = .$Patient_type) %>%
  lapply(function(x) select(x, -Patient_type)) %>%
  lapply(FUN = dplyr_summary) %>%
  lapply(FUN = function(df){
    df %>% t() %>% as.data.frame() %>% na.omit() %>% t()
  })
# Variable_summary_by_patient_type %>%
#  lapply(FUN = function(df){
#    df %>% format(digits = 2, drop0trailing = TRUE) %>% t() %>% kable()
#  })
```

```{r print_table1, echo=F, eval =F}
kable(Samples_per_centre, format = "markdown")
Summary_variables %>%
  select(-c(3)) %>%
  format(digits = 2, drop0trailing = TRUE) %>%
  t() %>%
  as.data.frame() %>%
  rename(sd = "standard deviation", min = minimum, max = maximum, 
         Q1 = "lower quartile", Q3 = "upper quartile") %>%
  kable(format = "markdown")
```

```{r print_data_characteristic_tables, cache = F, echo = F, warning=F}

table <- Variable_summary_by_centre %>% 
  lapply(FUN = function(df){df %>% format(digits = 2, drop0trailing = TRUE) %>% t()}) %>%
  do.call("rbind", .) 
colnames(table) <- c("Mean", "SD", "Minimim", "Q1", "Median", "Q3", "Maximum")
table %>%  
  kable("latex", align = "r", longtable = T, booktabs = T, 
      caption = "\\label{tab:summary_centre}Summary characteristics from each centre") %>%
  kable_styling(latex_options = c("repeat_header")) %>%
  group_rows("Cambridge", 1, 6, latex_gap_space = "0.6em", hline_after = T) %>%
  group_rows("Edinburgh", 7, 12, latex_gap_space = "0.6em", hline_after = T) %>%
  group_rows("London-Barts", 13, 18, latex_gap_space = "0.6em", hline_after = T) %>%
  group_rows("Manchester", 19, 24, latex_gap_space = "0.6em", hline_after = T) %>%
  group_rows("Melbourne", 25, 30, latex_gap_space = "0.6em", hline_after = T) %>%
  group_rows("Southampton", 31, 36, latex_gap_space = "0.6em", hline_after = T) %>%
  group_rows("Wales", 37, 42, latex_gap_space = "0.6em", hline_after = T) 

# kable(Variable_summary_by_centre[[1]], caption = "Cambridge: Summary characteristics") %>%
#   kable_styling(latex_options="scale_down")
# kable(Variable_summary_by_centre[[2]], caption = "Edinburgh: Summary characteristics") %>%
#   kable_styling(latex_options="scale_down")
# kable(Variable_summary_by_centre[[3]], caption = "London-Barts: Summary characteristics") %>%
#   kable_styling(latex_options="scale_down")
# kable(Variable_summary_by_centre[[4]], caption = "Manchester: Summary characteristics") %>%
#   kable_styling(latex_options="scale_down")
# kable(Variable_summary_by_centre[[5]], caption = "Melbourne: Summary characteristics") %>%
#   kable_styling(latex_options="scale_down")
# kable(Variable_summary_by_centre[[6]], caption = "Southampton: Summary characteristics") %>%
#   kable_styling(latex_options="scale_down")
# kable(Variable_summary_by_centre[[7]], caption = "Wales: Summary characteristics") %>%
#   kable_styling(latex_options="scale_down")

```

```{r print_data_diagnosis, cache = F, echo = F, warning=F}

func <- function(df){
  table(df$Diagnosis, df$Centre) %>%
  as.data.frame() %>%
  spread(key = Var2, value = Freq) %>%
  mutate(Total = rowSums(select(., -Var1))) %>% 
  arrange(-Total) %>%
  mutate(Diagnosis = as.character(Var1)) %>%
  select(-Var1)
  } 

New_nonIDMS_data %>%
  split(.$Patient_type) %>%
  lapply(func) %>%
  do.call(what = "bind_rows") %>%
  # column_to_rownames("Var1") %>%
  mutate_all(funs(replace(., is.na(.), 0))) %>%
  select(Diagnosis, Manchester, Edinburgh, Cambridge, Southampton, Melbourne, Wales, 
         'London-Barts', Total) %>%
  kable(caption = "\\label{tab:summary_diagnosis}Number of patients with given diagnoses in each centre") %>%
  kable_styling(latex_options="scale_down") %>%
  # kableExtra::landscape() %>%
  group_rows("Cancer", 1, 21, latex_gap_space = "0.6em", hline_after = T) %>%
  group_rows("Haematological", 22, 23, latex_gap_space = "0.6em", hline_after = T) %>%
  group_rows("Non-cancer", 23, 25, latex_gap_space = "0.6em", hline_after = T)

```

```{r output_data_characteristic_tables, cache = T, echo = F, eval =F}
add_name_to_col = function(x, y){
  as.data.frame(x) %>%
    rownames_to_column(var = "Statistic") %>%
    mutate(Centre = y) %>%
    select(Centre, Statistic, everything())
}
add_name_to_col = function(x, y){
  as.data.frame(x) %>%
    rownames_to_column(var = "Statistic") %>%
    mutate(Centre = y) %>%
    select(Centre, Statistic, everything())
}

ST1 = openxlsx::createWorkbook()

addWorksheet(ST1, "Centre diagnosis numbers")
writeData(ST1, 1, as.data.frame(Centre_diagnosis_summary), rowNames=FALSE)

addWorksheet(ST1, "Variable summary by centre")
Variable_summary_by_centre %>%
  mapply(add_name_to_col, x = ., y = names(.), SIMPLIFY = F) %>%
  do.call(bind_rows, .) %>%
  writeData(x = ., ST1, 2, rowNames=FALSE)

addWorksheet(ST1, "Summary by patient type")
Variable_summary_by_patient_type %>%
  mapply(add_name_to_col, x = ., y = names(.), SIMPLIFY = F) %>%
  do.call(bind_rows, .) %>%
  rename("Patient type" = "Centre") %>%
  writeData(x = ., ST1, 3, rowNames=FALSE)

saveWorkbook(ST1, file = paste0(fig_export_dir, "Data_summary_supplamet.xlsx"),
             overwrite = T)

T1 <- createWorkbook()
addWorksheet(T1, "Summary of variables")
writeData(T1, 1, as.data.frame(Samples_per_centre), startCol=1, rowNames=FALSE)
writeData(T1, 1, Summary_variables, startRow = 12, rowNames=T)
saveWorkbook(T1, paste0(fig_export_dir, "Data_summary_main.xlsx"), overwrite = T)

```

To facilitate data comparison graphically, Figure \ref{fig:centre_boxplot} displays the data from Table \ref{tab:summary_centre} in several boxplots. Patients from Southampton and London-Barts have a higher GFR, height and weight and a lower age than patients from other centres. This is attributable to the fact that the data from these centres were from patients with seminoma only and hence were typically from young men. The panel of log(creatinine) illustrates the inter-centre variability.

```{r data_characteristics_plot_1, echo = F, fig.width=9, fig.height=5, message=F, fig.cap="\\label{fig:centre_boxplot}Boxplot of the continuous variables split by centre. Creatinine has been log transformed."}
tol7qualitative=c("#332288", "#88CCEE", "#44AA99", "#117733", "#DDCC77","#CC6677","#AA4499")

Boxplots_variables <- New_nonIDMS_data %>%
  mutate(Centre = factor(Centre, levels = c("Manchester", "Edinburgh", "Cambridge",
                                    "Southampton", "Melbourne", "Wales",
                                    "London-Barts"))) %>%
  mutate("log(creatinine)" = log(Creat)) %>%
  select("GFR [ml/min]" = GFR, "log(creatinine)", "Age [years]" = Age, "Height [cm]" = Ht, 
         "Weight [kg]" = Wt, "BSA [m\u00B2]" = BSA, Centre) %>%
  gather(key = variable, value = value, -Centre) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(y = value, x = Centre, fill = Centre)) +
  geom_boxplot(position = "dodge", width = .9) +
  facet_wrap(~variable, scale = "free_y", nrow = 2) +
  ggplot_theme() +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank()) +
        # legend.position = c(7/8, 1/4),
        # legend.justification = c(.5, .5)) +
  scale_fill_manual(values = tol7qualitative)
Boxplots_variables
```

Figure \ref{fig:boxplot_creat} show boxplots for log(creatinine) split by centre for all patients and patients with selected diagnoses respectively. As patients with similar diagnoses should be approximately matched for the other variables, the plots facilitate further comparison of serum creatinine differences between centres.

```{r PLOT_analyse_creatinine, echo = F,  fig.width=9, fig.height=5, results = 'hide', message = F, fig.cap="\\label{fig:boxplot_creat}Boxplots of the serum creatinine of patients from different centres. Boxplots are shown for all patients combined and for patients with Germ Cell Tumours (GCT), Bladder or Transitional cell cancer (TCC), Thoracic cancer, Gastro-oesophageal cancer and Head and Neck cancer. The notches in the boxplots are $1.58 \\text{IQR} / \\sqrt{n}$ (where $n$ is the number of patients used for the given boxplot and IQR is the inter quartile range); they provide both an approximate 95% confidence interval for the median and an indication of the number of patients used for the given boxplot."}

tol7qualitative=c("#332288", "#88CCEE", "#44AA99", "#117733", "#DDCC77","#CC6677","#AA4499")

p1 <- New_nonIDMS_data %>%
  filter(Diagnosis %in% c("GCT", "Gyne", "Bladder/TCC", "Thoracic", 
                          "Gastroeosophageal", "Head and Neck")) %>%
  mutate(facet = Diagnosis) %>%
  bind_rows(mutate(New_nonIDMS_data, facet = "All patients")) %>%
  mutate(Centre = factor(Centre, 
                         levels = c("Manchester", "Edinburgh", "Cambridge", 
                                    "Southampton", "Melbourne", "Wales", 
                                    "London-Barts"))) %>%
  mutate(facet = factor(facet, 
                        levels = c("All patients", "GCT", "Gyne", "Bladder/TCC", 
                                   "Thoracic", "Gastroeosophageal", "Head and Neck"))) %>%
  group_by(Centre) %>% mutate(n = n()) %>% ungroup() %>%
  ggplot(aes(y = log(Creat))) +
  geom_boxplot(aes(fill = Centre), position = position_dodge(), notch =T) +
  facet_wrap(~facet, nrow = 2) +
  ggplot_theme() +
  theme(text = element_text(size = 14)) +
  ylab("log(creatinine)") + 
   theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank()) +
        # legend.position = c(7/8, 1/4),
        # legend.justification = c(.5, .5)) +
  scale_fill_manual(values = tol7qualitative)
p1

ggsave(paste0(fig_export_dir, "Supplemental_Figure_1.pdf"), width = 12, height = 9, p1)
```

Figure \ref{fig:boxplot_diagnosis} takes the same format as Figure \ref{fig:centre_boxplot} but displays subgroups of patients based on diagnosis. Subgroups with more than 50 patients were included.

```{r data_characteristics_plots_2, echo = F, fig.width=9, fig.height=5, fig.cap="\\label{fig:boxplot_diagnosis}Boxplot of the continuous variables split by diagnosis. Subgroups with more than 50 patients are displayed. Subgroups with fewer than 50 patients have been combined with patients with an unknown diagnosis into the group Other. Boxplots are arranged by decreasing patient numbers from left to right. Serum creatinine has been log transformed."}
tol12qualitative=c("#332288", "#6699CC", "#88CCEE", "#44AA99", "#117733",
                    "#999933", "#DDCC77", "#661100", "#CC6677", "#AA4466",
                    "#882255", "#AA4499")

Boxplots_diagnosis <- New_nonIDMS_data %>%
  group_by(Diagnosis) %>% mutate(n = n()) %>% ungroup() %>%
  mutate(Diagnosis = ifelse(n < 50, "Other", Diagnosis)) %>%
  mutate(Diagnosis = ifelse(Diagnosis == "Unknown", "Other", Diagnosis)) %>%
  group_by(Diagnosis) %>% mutate(n = n()) %>% ungroup() %>%
  mutate(Diagnosis = factor(Diagnosis, levels = unique(.$Diagnosis[order(.$n, decreasing = T)]))) %>%
  mutate("log(creatinine)" = log(Creat)) %>%
  select("GFR [ml/min]" = GFR, "log(creatinine)", "Age [years]" = Age, "Height [cm]" = Ht, 
         "Weight [kg]" = Wt, "BSA [m\u00B2]" = BSA, Diagnosis) %>%
  # select("GFR" = GFR, "log(creatinine)", Age, Height = Ht, Weight = Wt, "BSA" = BSA, Diagnosis) %>%
  gather(key = variable, value = value, -Diagnosis) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(y = value, x = Diagnosis, fill = Diagnosis)) +
  geom_boxplot(position = "dodge", width = .9,  notch =T) +
  facet_wrap(~variable, scale = "free_y", nrow = 2) +
  ggplot_theme() +
  scale_fill_manual(values = c(tol12qualitative, "grey50", "white")) +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank())
Boxplots_diagnosis
```

Information on ethnicity was available for patients from Cambridge and Manchester, who comprised the majority of patients. From a total of `r format(nrow(filter(New_nonIDMS_data, !is.na(Ethnicity))), big.mark=",", scientific=FALSE)` patients with known ethnicity, `r format(nrow(filter(New_nonIDMS_data, Ethnicity == "White")), big.mark=",", scientific=FALSE)` were White (either White British, White Irish, White other), `r nrow(filter(New_nonIDMS_data, Ethnicity == "Asian"))` were Asian (Asian Indian, Asian Pakistani, Asian Bangladeshi, Asian other, Chinese, Other Chinese, Mixed White and Asian), `r nrow(filter(New_nonIDMS_data, Ethnicity == "Black"))` were Black (Black African, Black Caribbean, Black other, Mixed White and Black Caribbean, Mixed White and Black African) and `r nrow(filter(New_nonIDMS_data, Ethnicity == "Other"))` were of other ethnicity (other ethnic group, other mixed). Figure \ref{fig:boxplot_race} shows boxplots for age, BSA, mGFR and log(creatinine) for patients from the ethnic subgroups. As white patients were the largest subgroup, t-tests were performed to look for differences between this subgroup and each other subgroup. There were no significant differences in the serum creatinine levels for patients from different ethnicities. However, there were significant differences in the other variables and therefore the subgroups were not matched. Given the correlations between these variables, it is difficult to interpret the creatinine comparisons precisely. To determine whether the average creatinine values differ between white and black patients when the other variables are similar, we sampled 22 white patients from the population that matched the set of black patients with regards to sex and age ten times. We then performed t-tests for these ten samples for log(creatinine), measured GFR and BSA. No significant differences were found (Table \ref{tab:race_resample}).


```{r Ethnicity_boxplot, eval = T, echo=F, fig.width=9, message = F, warning=F, fig.height=6, fig.cap="\\label{fig:boxplot_race}Boxplots of age, BSA, GFR and log(creatinine) and Age where patients are split by ethnicity. The '\\*' or 'ns' at the top of the boxplot represents the p-value from a t-test between the largest subgroup of white patients and each other ethnic subgroups, where 'ns' represents a p-value greater than 0.05 and '\\*', '\\*\\*' and '\\*\\*\\*' represent p-values less than 0.05, 0.01 and 0.001 respectively."}

tol4qualitative=c("#4477AA", "#117733", "#DDCC77", "#CC6677")
Boxplots_ethnicity <- New_nonIDMS_data %>%
  filter(!is.na(Ethnicity)) %>%
  mutate("log(creatinine)" = log(Creat)) %>%
  select("GFR [ml/min]" = GFR, "log(creatinine)", "Age [years]" = Age, 
         "BSA [m\u00B2]" = BSA, Centre, Ethnicity) %>%
  # select(Age, GFR, BSA, "log(Creat)", Centre, Ethnicity) %>%
  gather(key = variable, value = value, -Centre, -Ethnicity) %>%
  ggplot(aes(y = value, fill = Ethnicity, x = Ethnicity)) +
  geom_boxplot(position = "dodge", width = 1, notch = T, outlier.shape = NA) +
  geom_jitter(aes(alpha = Ethnicity), width = .3) +
  scale_alpha_manual(values = c(.5,.5,.5,.05)) +
  ggplot_theme() +
  facet_wrap(~variable, scales = "free_y") +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.x=element_text(angle=45, hjust=1)) +
  scale_fill_manual(values = tol4qualitative) +
  stat_compare_means(method = "t.test", label = "p.signif", ref.group = "White")
Boxplots_ethnicity

# Ethnicity_data %>%
#   mutate(CKD = CKD_adj_model_data(.)) %>%
#   mutate(CKD_race_adj = ifelse(Ethnicity == "Black", CKD*1.159, CKD)) %>%
#   filter(Ethnicity %in% c("Black")) %>%
#   ggplot() +
#   geom_hline(yintercept = 0, colour = "grey50") +
#   geom_point(aes(x = CKD, y = GFR - CKD, shape = Creatinine_type), colour = "black") +
#   geom_point(aes(x = CKD_race_adj, y = GFR - CKD_race_adj, shape = Creatinine_type),
#              colour = "red") +
#   geom_segment(aes(x = CKD,  y = GFR - CKD, xend = CKD_race_adj,
#                    yend = GFR - CKD_race_adj)) +
#   ggplot_theme()
#
#
# Ethnicity_data %>%
#   mutate(CKD = CKD_adj_model_data(.)) %>%
#   mutate(CKD_race_adj = ifelse(Ethnicity == "Black", CKD*1.159, CKD)) %>%
#   mutate(log_Creat = log(Creat)) %>%
#   mutate(CamGFR = predict(Original_model, newdata = .)^2) %>%
#   select(CKD_race_adj, CKD, CamGFR, Ethnicity, GFR) %>%
#   gather(key = equation, value = fitted, -GFR, -Ethnicity) %>%
#   mutate(resid = GFR - fitted) %>%
#   filter(Ethnicity == "Black") %>%
#   group_by(equation, Ethnicity) %>%
#   Statistic_summary_withP20()

```

```{r ethnicity_matched_sampling, echo =F, eval =T}
WP <- New_nonIDMS_data %>%
  filter(Ethnicity == "White")
BP <- New_nonIDMS_data %>%
  filter(Ethnicity == "Black") %>%
  select(Age, Creat, Ethnicity, GFR, BSA)

# aaa <- WP %>%
#   group_by(Sex) %>%
#   nest() %>%
#   mutate(n = c(12, 10))
# 
# sample_list = list()
# i <- 1
# j <- 1
# while(length(sample_list) < 10){
#   sample = aaa %>%
#     mutate(samp = map2(data, n, sample_n)) %>%
#     select(Sex, samp) %>%
#     unnest()
#   m <- mean(sample$Age)
#   j <- j + 1
#   print(c(i, j, m))
#   if(46.9 < m & m < 48.9){
#     sample_list[[i]] <- sample
#     i <- i + 1
#   }
# }
# save(sample_list, file = "sample_list_ethnicity.RData")

load("sample_list_ethnicity.RData")

Matched_samples <- lapply(sample_list, function(x) bind_rows(x, BP))

data.frame(
  Age = unlist(lapply(Matched_samples, 
                      function(a) t.test(Age ~ Ethnicity, a)$p.value)), 
  Creat = unlist(lapply(Matched_samples, 
                        function(a) t.test(log(Creat) ~ Ethnicity, a)$p.value)),
  GFR = unlist(lapply(Matched_samples, 
                      function(a) t.test(GFR ~ Ethnicity, a)$p.value)),
  BSA = unlist(lapply(Matched_samples, 
                      function(a) t.test(BSA ~ Ethnicity, a)$p.value))) %>%
  mutate_all(funs(round(., digits = 2))) %>%
  rename("log(creatinine)" = Creat, "Age [years]" = Age, "GFR [ml/min]" = GFR,  "BSA [m\u00B2]" = BSA) %>%
  kable(caption = "\\label{tab:race_resample}t-test p-values for comparing the mean age, log(creatinine), GFR and BSA between 22 patients who were ethnically black and 22 random patients who were ethnically white and matched by mean age (mean age within 1 year) and the same gender distribution (12 females and 10 males).")

```


# Comparison of models

We compared the CamGFR [@Janowitz2017a] model with the the following published models: CKD-EPI [@Levey2009], MDRD (186 version) [@Levey1999], Wright [@Wright2001], Cockcroft-Gault [@Cockcroft1976], Jelliffe [@Jelliffe1973], Mayo [@Rule2004] and Martin [@Martin1998]. If these equations estimated BSA-normalised GFR (CKD-EPI, MDRD, Jelliffe and Mayo), the estimated value was subsequently unnormalised by multiplying the estimated value by $1.73/\textrm{BSA}$, where $\textrm{BSA}$ is the patient's body surface area estimated using the DuBois-DuBois equation: 
$$\textrm{BSA} = 0.20247 \times \textrm{Height}^{0.725} \times \textrm{Weight}^{0.425}$$ 
where height is measured in metres and weight is measured in kg. Some of these models (Cockroft-Gault and Jelliffe) were developed to estimate creatinine clearance and not GFR, where creatinine clearance is itself a biased estimator of GFR. These models are included as they are still used to estimate GFR by some centres, clinical trial groups, and in other settings. 

The equations were compared using three metrics: the root-mean-squared-error (RMSE), median residual value, and the residual interquartile range (IQR). These three metrics are estimators for a model’s accuracy, bias and precision respectively. A 95% confidence interval was calculated for each of these metrics using the bootstrap resampling procedure. Specifically, 2,000 resamples with replacement (where the sample size was the same as the number of data points) were taken from the data used to calculate the metric. The metric was then calculated for each of these 2,000 samples and using the normal approximation a confidence interval was constructed [@Davison2013]. The same seed was used for different metrics.

The main results of this analysis are reported in Figure 1 (results for patients split by centre) in the main manuscript along with Figures \ref{fig:performace_diagnosis} (results for patients split by diagnosis), \ref{fig:performace_age} (results for patients split by age) and \ref{fig:performace_BSA} (results for patients split by BSA). Additionally, all numerical results are reported in Table S5 (an additional file). Table S5 gives the results for all equations above whereas the Figures only compare the performance of CamGFR, CKD-EPI, MDRD, Wright and Cockroft-Gault. 

Additionally, we compared the performance of the CamGFR and CKD-EPI models with the aid of a Bland-Altman plot (or MA plot) and residual vs fitted plots (Figure \ref{fig:CKD_CamGFR_plot}). The Bland-Altman plot is used to contrast accuracy, whereas the fitted vs residual plot is used to to assess the performance of a model. The feature which is most noticeable from  Figure \ref{fig:CKD_CamGFR_plot} is that for low eGFR (approximately less than 50 ml/min),  CamGFR estimates larger values than CKD-EPI. The inverse is true for high eGFR, culminating in a sight overall bias for eGFR to be higher in the CKD-EPI than CamGFR. The variability between the two models increases as eGFR increases. This can be partly explained by the fact that CamGFR and CKD-EPI model GFR on a square root and log scale respectively. The fitted vs residual plots are similar for the two models. 


```{r performance_nonIDMS_data_tables, echo=F, cache=T, include=FALSE}

# set seed for consistency in the bootstrap resampling estimated CIs
set.seed(123)

# create table of estimations to summarise
Table_df <- New_nonIDMS_data %>%
  # filter(Centre != "Melbourne") %>%
  group_by(Diagnosis) %>% mutate(n = n()) %>% ungroup() %>%
  mutate(Diagnosis = ifelse(n < 50, "Other", Diagnosis)) %>%
  mutate(Date_diff = as.numeric(Date_GFR - Date_creat)) %>%
  mutate(Date_diff_group = cut(Date_diff, breaks = c(-31, -8, -3, -1, 0, 2, 7, 30))) %>%
  mutate(Date_diff_group = as.character(Date_diff_group)) %>%
  mutate(Date_diff_group = ifelse(is.na(Date_diff_group), "NA", Date_diff_group)) %>%
  bind_cols(GFR_fitted_values_eth(.)) %>%
  select(WJ, CKD_adj, MDRD_adj, Wright, Cockcroft, Jelliffe_adj, Mayo_adj, Martin,
         # LM_adj, FAS_adj, 
         GFR, Centre, Age, Creat, Diagnosis, Patient_type, BSA, Sex, Date_diff,
         Date_diff_group) %>%
  gather(key = equation, value = fitted, -GFR, -Centre, -Age, -BSA, -Creat, -Diagnosis,
         -Patient_type, -Sex, -Date_diff, -Date_diff_group) %>%
  mutate(GFR = (GFR), fitted = (fitted)) %>%
  mutate(resid = GFR - fitted) 

Clean_output_table <- function(table){
  table %>%
   ungroup() %>%
   mutate(equation = factor(equation,
                           levels = c("WJ", "CKD_adj", "Wright", "MDRD_adj", 
                                      # "LM_adj", "FAS_adj",
                                      "Cockcroft", "Jelliffe_adj", "Martin", "Mayo_adj"),
                           labels = c("CamGFR", "CKD-EPI", "Wright", "MDRD-186", 
                                      # "LM", "FAS", 
                                      "Cockcroft-Gault", "Jelliffe", "Martin", "Mayo"))) %>%
    mutate_at(.vars = vars(median_fitted, starts_with("RMSE"), starts_with("IQR"),
                           starts_with("median")),
              funs(round(., 2))) %>%
    mutate_at(.vars = vars(starts_with("P20")),
              funs(round(., 3))) %>%
    rename("median fitted value" = median_fitted) %>%
    mutate(RMSE = paste0(RMSE, " (", RMSE_lwr, ", ", RMSE_upr, ")")) %>%
    mutate(median = paste0(median, " (", median_lwr, ", ", median_upr, ")")) %>%
    mutate(IQR = paste0(IQR, " (", IQR_lwr, ", ", IQR_upr, ")")) %>%
    mutate("1-P20" = paste0(P20, " (", P20_lwr, ", ", P20_upr, ")")) %>%
    select(-RMSE_lwr, -RMSE_upr, -median_lwr, -median_upr, -IQR_lwr, -IQR_upr, -P20_lwr,
           -P20_upr, -P20)
}

Results_nonIDMS_data <- Table_df %>%
  group_by(equation) %>%
  Statistic_summary_withP20_both() %>%
  # select(-P20, -P20_lwr, -P20_upr)
  select(-P20_dose, -P20_dose_lwr, -P20_dose_upr) %>%
  arrange(RMSE) 

Clean_Results_nonIDMS_data <-
  Clean_output_table(Results_nonIDMS_data)

Results_nonIDMS_data_type <- Table_df %>%
  group_by(Patient_type, equation) %>%
  Statistic_summary_withP20_both() %>%
  arrange(Patient_type, RMSE) %>%
  # select(-P20, -P20_lwr, -P20_upr)
  select(-P20_dose, -P20_dose_lwr, -P20_dose_upr)
Clean_Results_nonIDMS_data_type <-
  Clean_output_table(Results_nonIDMS_data_type)

Results_nonIDMS_data_centre <- Table_df %>%
  group_by(equation, Centre) %>%
  Statistic_summary_withP20_both() %>%
  arrange(Centre, RMSE) %>%
  # select(-P20, -P20_lwr, -P20_upr)
  select(-P20_dose, -P20_dose_lwr, -P20_dose_upr)
Clean_Results_nonIDMS_data_centre <-
  Clean_output_table(Results_nonIDMS_data_centre)

Results_nonIDMS_data_pat_type <- Table_df %>%
  group_by(equation, Patient_type) %>%
  Statistic_summary_withP20_both() %>%
  arrange(Patient_type, RMSE) 
  # select(-P20, -P20_lwr, -P20_upr) %>%
  # select(-P20_dose, -P20_dose_lwr, -P20_dose_upr)
Clean_Results_nonIDMS_data_pat_type <- 
  Results_nonIDMS_data_pat_type %>%
  select(-P20_dose, -P20_dose_lwr, -P20_dose_upr) %>%
  Clean_output_table()

Results_nonIDMS_data_diagnosis <- Table_df %>%
  group_by(equation, Diagnosis) %>%
  Statistic_summary_withP20_both() %>%
  arrange(Diagnosis, RMSE) %>%
  # select(-P20, -P20_lwr, -P20_upr)
  select(-P20_dose, -P20_dose_lwr, -P20_dose_upr)
Clean_Results_nonIDMS_data_diagnosis <-
  Clean_output_table(Results_nonIDMS_data_diagnosis)

Results_nonIDMS_data_sex <- Table_df %>%
  group_by(equation, Sex) %>%
  Statistic_summary_withP20_both() %>%
  arrange(Sex, RMSE) %>%
  # select(-P20, -P20_lwr, -P20_upr)
  select(-P20_dose, -P20_dose_lwr, -P20_dose_upr)
Clean_Results_nonIDMS_data_sex <-
  Clean_output_table(Results_nonIDMS_data_sex)


Results_nonIDMS_data_creat <-  Table_df %>%
  mutate(Creat_cut = cut_number(Creat, 5)) %>% 
  group_by(equation, Creat_cut) %>%
  Statistic_summary_withP20_both() %>%
  arrange(Creat_cut, RMSE) %>%
  # select(-P20, -P20_lwr, -P20_upr)
  select(-P20_dose, -P20_dose_lwr, -P20_dose_upr)
Clean_Results_nonIDMS_data_creat <-
  Clean_output_table(Results_nonIDMS_data_creat)

Results_nonIDMS_data_date_diff <- Table_df %>%
  group_by(equation, Date_diff_group) %>%
  Statistic_summary_withP20_both() %>%
  arrange(Date_diff_group, equation) %>%
  # select(-P20, -P20_lwr, -P20_upr)
  select(-P20_dose, -P20_dose_lwr, -P20_dose_upr)
Clean_Results_nonIDMS_data_date_diff <-
  Clean_output_table(Results_nonIDMS_data_date_diff)

```

<!-- Figure 1 in the main manuscript shows the results when split by centre. In addition, Figure 4 plot the data the comparison between models with patients split into by cancer diagnosis. We required at least 50 patients to have the given diagnosis all other diagnosis is not included. There are several interesting observations from this Figure. Firstly, CamGFR outperforms all other models in all but 4 of the diagnosis subgroups. Secondly, the performance of all model varies for different diagnosis subgroups. For example, GFR is estimated less well for Germ Cell patients on average and patient with Oesophageal or Gastric cancer are predicted particularly accurately. Bias too tends to fluctuate for all models in different patient diagnosis subgroups. Thirdly, the variability of the accuracy of the models varies between the different diagnosis subgroup, with Hematological or Sarcoma cancers having a particularly high variance for the accuracy in all models. -->



```{r CKD_CamGFR_GFR_plot, echo = F, fig.width=13, fig.height=10, fig.cap="\\label{fig:CKD_CamGFR_plot}Comparison of GFR estimated by CamGFR and CKD-EPI, the two best performing model. A) Bland-Altman plot of GFR estimated using the CamGFR and CKD-EPI models. B) Residual (GFR - eGFR) vs fitted value (eGFR) for both the CamGFR and CKD-EPI models."}


plot_df <- New_nonIDMS_data %>%
  # filter(Centre != "Melbourne") %>%
  group_by(Diagnosis) %>% mutate(n = n()) %>% ungroup() %>%
  mutate(Diagnosis = ifelse(n < 50, "Other", Diagnosis)) %>%
  bind_cols(GFR_fitted_values_eth(.)) %>%
  select(GFR, CKD_adj, WJ, Centre, Sex)


p1 <- plot_df %>%
  rename("CamGFR" = "WJ", "CKD-EPI" = "CKD_adj") %>%
  gather(key = model, value = eGFR, "CKD-EPI", "CamGFR") %>%
  ggplot(aes(x = eGFR , y = GFR - eGFR, colour = Centre)) +
  geom_hline(yintercept = 0) +
  geom_point(alpha = 0.5) +
  facet_wrap(~model) +
  ggplot_theme() +
  theme(text = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  scale_colour_manual(values = tol7qualitative) + 
  theme(legend.position = "none") + 
  theme(text = element_text(size = 14))


sd = plot_df %>% 
  mutate(diff = WJ - CKD_adj) %>% 
  pull(diff) %>%
  sd()
m = plot_df %>% 
  mutate(diff = WJ - CKD_adj) %>% 
  pull(diff) %>%
  mean()

p3 <- ggplot(plot_df, aes(x = (WJ + CKD_adj)/2, y = WJ - CKD_adj, colour = Centre)) + 
  geom_hline(yintercept = 0) + 
  geom_point(alpha = 0.5) + 
  ggplot_theme() +
  theme(text = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  ylab("CamGFR - CKD-EPI") + 
  xlab("(CamGFR + CKD-EPI)/2") +
  scale_colour_manual(values = tol7qualitative) + 
  theme(legend.position = "right") + 
  geom_hline(yintercept = m + c(-1,0,1)*sd*1.96, linetype = "dashed") + 
  theme(text = element_text(size = 14))


CamGFR_CKDEPI_comparison_plot <- 
  ggdraw() +
  draw_plot(p3, 0.2, 0.5, .7, .5) +
  draw_plot(p1, 0, 0, 1, .5) +
  draw_plot_label(c("A", "B"), c(.1, 0), c(1, 0.5), size = 18)

CamGFR_CKDEPI_comparison_plot

```



```{r Load_plots, include=FALSE, message = FALSE, warnings = FALSE, cache=T}
source("1_Validation_paper_figure.R") 

```

```{r PLOT_dagnosis, echo = F, fig.width=13, fig.height=10, fig.cap="\\label{fig:performace_diagnosis}Performance of GFR models for patients from different diagnostic subgroups. The results for the CamGFR model and four other commonly used models (CKD-EPI, Wright, MDRD-186 and Cockcroft-Gault) are displayed. Results for those diagnostic subgroups that had more than 50 patients are shown. First row: the residual (measured GFR - estimated GFR) median, which is a measure of a model’s bias, is displayed. Second row: the residual interquartile range (IQR), which is a measure of a model’s precision, is displayed. Third row: the root-mean-squared error (RMSE), which is a measure of a model’s accuracy, is displayed. Accuracy is a combination metric of bias and precision. Fourth row: The proportion of patients who have an absolute percentage error more than 20% (1-P20), which reflects clinical robustness by illustrating the proportion of patients with a clinically relevant error, is displayed. The best result would be closest to zero for the residual median, and the smallest value for IQR, RMSE, and 1-P20. All error bars are 95% confidence intervals calculated using bootstrap resampling with 2,000 repetitions and a normal distribution approximation."}
plot(plot_diagnosis)
```

We analysed performance when patients were split into groups by their age or BSA. Figures \ref{fig:performace_age}, \ref{fig:performace_BSA}, and \ref{fig:performace_Creat} show the performance of each model for equally sized subgroups of age, BSA, and creatinine respectively. The accuracy of all models tends to increase with increasing age and tends to increase with increasing BSA. These observations can be largely explained by the fact that GFR is modelled on the square root scale in the CamGFR model and on the log scale for the CKD-EPI or MDRD models. Patients who are young or have a large BSA also tend to have a higher GFR and patients with a higher GFR will have a less accurate estimated GFR due to modelling on a square-root or log scale. As discussed in the main manuscript, CamGFR is not the most accurate for the subgroups split by serum creatinine. For the lower two groups CamGFR, is the most accurate model for all subgroups split by serum creatinine. For the two groups with lower creatinine, CamGFR is the most accurate model. In particular, for the group of patients with the lowest serum creatinine values all other models are biased to overestimate GFR.


```{r PLOT_performance_age, echo = F, message = F, warnings = F, fig.width=13, fig.height=10, fig.cap="\\label{fig:performace_age}Comparison of model performance in different age groups. The results for five published models are shown. Patients were split into 10 equally sized groups by their age. \\(*a*,*b*\\] denotes the interval *a* to *b* which is exclusive of the lower and inclusive of the higher age."}
plot(plot_age)
```

```{r PLOT_performance_BSA, echo = F, message = F, warnings = F,fig.width=13, fig.height=10, fig.cap="\\label{fig:performace_BSA}Comparison of model performance in different BSA groups. The results for five published models are shown. Patients were split into 10 equally sized groups by their BSA. \\(*a*,*b*\\] denotes the interval *a* to *b* which is exclusive of the lower and inclusive of the higher BSA."}
plot(plot_BSA) 
```

```{r PLOT_performance_Creat, echo = F, message = F, warnings = F, fig.width=13, fig.height=10, fig.cap="\\label{fig:performace_Creat}Comparison of model performance in different BSA groups. The results for five published models are shown. Patients were split into 10 equally sized groups by their BSA. \\(*a*,*b*\\] denotes the interval *a* to *b* which is exclusive of the lower and inclusive of the higher BSA."}
plot(plot_Creat) 
```


```{r PLOT_performance_data_diff, echo = F, message = F, warnings = F,fig.width=13, fig.height=10, fig.cap="\\label{fig:performace_date_diff}Comparison of model performance patients split by the difference in time between the GFR and creatinine measurement dates. The results for five published models are shown. A negative date difference corresponds to creatinine measured after GFR."}
plot(plot_date_diff) 
```





P-values for the differences between a statistic for a pair of equations were calculated using a bootstrap procedure described by Efron[@Efron1994]. In this procedure we have two samples $\mathbf{z}$ and $\mathbf{y}$ of lengths $n$ and $m$ respectively, from possibly different probability distributions $F$ and $G$. In our case $F$ and $G$ were the probability distributions of the residuals for the two equations of interest. We tested the null hypothesis $H_0: F = G$, against the alternative hypothesis $H_0: F \neq G$. Let $x = [z,y]$, and chose a test statistic $t(\mathbf{x})$, which had the form $t(\mathrm{x}) = f(\mathrm{z}) - f(\mathrm{y})$, where the function $f(\mathrm{w})$ was either RMSE, median or IQR. Using the following procedure an approximate p-value was calculated by: 

\begin{itemize}
\item For $r = 1, ..., R$ let $\mathrm{x}^*_r$ be a sample with replacement of size $n+m$ from the pooled vector $\mathrm{x} = [\mathrm{z}, \mathrm{y}]$. Let $\mathrm{z}^*_r$ be the first $n$ observations of  $\mathrm{x}^*_r$ and $\mathrm{y}^*_r$ the remaining $m$ observations.
\item Let 
$$t_r^* = t(\mathrm{x}^*_r) = f(\mathrm{z}^*_r) - f(\mathrm{y}^*_r), \quad r = 1, 2, ..., R$$
\item Calculate the approximate p-value for the hypothesis test as: 
$$ \widehat{p} =\frac{1 + \sum_{r=1}^R \mathbb{1}_{\left| t_r^*\right| \geq \left| t_{obs}\right|}}{R + 1}$$ 
where $t_{obs} = t(\mathrm{x}) = f(\mathrm{z}) - f(\mathrm{y})$ is the observed value of the statistic and $\mathbb{1}_A$ is the indicator function which returns $1$ if $A$ is true and $0$ otherwise. The absolute values of $t$ are considered so as to perform a two-sided test. 
\end{itemize}

It should be noted that that the hypothesis test is strictly testing the null hypothesis $H_0 :F=G$ and not the null hypothesis $H_0: f(Z) = f(G)$. When the approximate p-values are calculated with the statistic 1-P20 (the proportion of patients with an absolute percentage error more than 20%), $z$ and $y$ would be the vectors of percentage differences between the fitted and measured dose values. Approximate p-values (with $R = 10,000$) are given in Table S5 (an additional file).

```{r bootstrap_p_values, echo = F, eval = F, cache=T}
# calculate resuting bootstrap p-values for statistics
change_names <- function(x){
  factor(x, 
         levels = c("WJ", "CKD_adj", "Cockcroft", "Jelliffe_adj", "Martin", 
                    "Mayo_adj", "MDRD_adj",  "Wright"), 
         labels = c("CamGFR", "CKD-EPI", "Cockcroft-Gault", "Jelliffe", "Martin", 
                    "Mayo", "MDRD-186", "Wright"))
}


p_values_all <- Table_df %>%
  mutate(equation = change_names(equation)) %>%
  Bootstrap_all_stats_all_equation()

p_values_centre <- Table_df %>%
  mutate(equation = change_names(equation)) %>%
  split(., .$Centre) %>%
  lapply(. , Bootstrap_all_stats_all_equation)

p_values_pat_type <- Table_df %>%
  mutate(equation = change_names(equation)) %>%
  split(., .$Patient_type) %>%
  lapply(. , Bootstrap_all_stats_all_equation)


p_values_diagnosis <- Table_df %>%
  mutate(equation = change_names(equation)) %>%
  group_by(Diagnosis) %>%
  filter(n() > 50 ) %>% 
  ungroup() %>%
  split(., .$Diagnosis) %>%
  lapply(. , Bootstrap_all_stats_all_equation)

p_values_sex <- Table_df %>%
  mutate(equation = change_names(equation)) %>%
  split(., .$Sex) %>%
  lapply(. , Bootstrap_all_stats_all_equation)

p_values_Creat <- Table_df %>%
  mutate(Creat_cut = cut_number(Creat, 5)) %>% 
  mutate(equation = change_names(equation)) %>%
  split(., .$Creat_cut) %>%
  lapply(. , Bootstrap_all_stats_all_equation)

p_values_date_diff <- Table_df %>%
  mutate(equation = change_names(equation)) %>%
  split(., .$Date_diff_group) %>%
  lapply(. , Bootstrap_all_stats_all_equation)


names = names(p_values_centre)
p_values_centre_all = 
  lapply(1:length(p_values_centre), function(i) mutate(p_values_centre[[i]], Centre = names[i])) %>%
  do.call(what = rbind, args = .)


names = names(p_values_diagnosis)
p_values_diagnosis_all = 
  lapply(1:length(p_values_diagnosis), function(i) mutate(p_values_diagnosis[[i]], Diagnosis = names[i])) %>%
  do.call(what = rbind, args = .)

names = names(p_values_pat_type)
p_values_pat_type_all = 
  lapply(1:length(p_values_pat_type), function(i) mutate(p_values_pat_type[[i]], Patient_type = names[i])) %>%
  do.call(what = rbind, args = .)

names = names(p_values_sex)
p_values_sex_all = 
  lapply(1:length(p_values_sex), function(i) mutate(p_values_sex[[i]], Sex = names[i])) %>%
  do.call(what = rbind, args = .)

names = names(p_values_Creat)
p_values_creat_all = 
  lapply(1:length(p_values_Creat), function(i) mutate(p_values_Creat[[i]], Creat_cut = names[i])) %>%
  do.call(what = rbind, args = .)

names = names(p_values_date_diff)
p_values_date_diff_all = 
  lapply(1:length(p_values_date_diff), function(i) mutate(p_values_date_diff[[i]], Date_diff_group = names[i])) %>%
  do.call(what = rbind, args = .)
```

```{r output_nonIDMS_results_table, echo = F, eval = F, include = F}
ST2 = openxlsx::createWorkbook()

addWorksheet(ST2, "Results for all data")
writeData(ST2, 1, as.data.frame(Clean_Results_nonIDMS_data),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Results split by centre")
writeData(ST2, 2, as.data.frame(Clean_Results_nonIDMS_data_centre),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Results split by patient type")
writeData(ST2, 3, as.data.frame(Clean_Results_nonIDMS_data_pat_type),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Results split by diagnosis")
writeData(ST2, 4, as.data.frame(Clean_Results_nonIDMS_data_diagnosis),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Results split by sex")
writeData(ST2, 5, as.data.frame(Clean_Results_nonIDMS_data_sex),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Results split by creatinine")
writeData(ST2, 6, as.data.frame(Clean_Results_nonIDMS_data_creat),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Results split by date diff")
writeData(ST2, 7, as.data.frame(Clean_Results_nonIDMS_data_date_diff),  startCol=1, rowNames=FALSE)



addWorksheet(ST2, "Resuls all p-values")
writeData(ST2, 8, as.data.frame(p_values_all),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Centre p-values")
writeData(ST2, 9, as.data.frame(p_values_centre_all),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Patient type p-values")
writeData(ST2, 10, as.data.frame(p_values_pat_type_all),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Diagnosis p-values")
writeData(ST2, 11, as.data.frame(p_values_diagnosis_all),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Sex p-values")
writeData(ST2, 12, as.data.frame(p_values_sex_all),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Creatinine p-values")
writeData(ST2, 13, as.data.frame(p_values_creat_all),  startCol=1, rowNames=FALSE)

addWorksheet(ST2, "Date diff p-values")
writeData(ST2, 14, as.data.frame(p_values_date_diff_all),  startCol=1, rowNames=FALSE)

saveWorkbook(ST2, paste0(fig_export_dir, "Supplemental_table_1.xlsx"), overwrite = T)
```

\newpage

# Published models

This section gives the published models used in this manuscript. In the following equations: 
\begin{itemize}
\item $Age$ is the patient's Age in years
\item $BSA$ is the patient's body surface area in $m^2$, if is estimated for the patients weight and weight using the DuBois DuBois equation [@Janowitz2017a] 
\item $Scr$ is the patient's blood serum creatinine in $mg/dL$
\item $Wt$ is the patient's weight is $kg$
\end{itemize}

## CamGFR [@Janowitz2017a]

\begin{dmath*}
GFR = \left( 1.81395 + 0.01914\!\!\times\!\! Age  + 4.73278\!\!\times\!\! BSA - 0.02970 \!\!\times\!\! Age\!\!\times\!\! BSA - 3.71619\!\!\times\!\! \text{log}\left( Scr\right) + 1.06284 \!\!\times\!\! \text{log}\left( Scr\right)^2 -0.91420 \!\!\times\!\! \text{log}\left( Scr\right)^3 + \left( 0.02020 + 0.01247\!\!\times\!\! Age\right) \left[ \text{if male} \right] \right)^2
\end{dmath*}


## CKD-EPI [@Levey2009]

\begin{equation*}
GFR = \begin{cases}
141\times \text{min}\left(\frac{Scr}{0.7}, 1\right)^{-0.329} \times \text{max}\left(\frac{Scr}{0.7}, 1\right)^{-1.209} \times Age^{0.993} \times 1.018 & \text{if Sex = F} \\
141\times \text{min}\left(\frac{Scr}{0.9}, 1\right)^{-0.411} \times \text{max}\left(\frac{Scr}{0.9}, 1\right)^{-1.209} \times Age^{0.993}  & \text{if Sex = M}
      \end{cases}
\end{equation*}

```{r ckd, echo=FALSE, eval = F}
CKD_model = function(a, b_F, b_M, c_F, c_M, d, e, f, Sex, Scr, Age){
  # the CKD-EPI model with all parsamaters as variables
  n = length(Age)
  log_GFR = rep(0,n)
  for(i in 1:n){
    if(Sex[i] == "F"){
      log_GFR[i]  <- log(a) + c_F*log(min(Scr[i]/b_F,1)) +
        d*log(max(Scr[i]/b_F,1)) + Age[i]*log(e) + log(f)
    }
    else if(Sex[i] == "M"){
      log_GFR[i]  <- log(a) + c_M*log(min(Scr[i]/b_M,1)) +
        d*log(max(Scr[i]/b_M,1)) + Age[i]*log(e)
    }
    else{
      stop("Sex must be F or M")
    }
  }
  GFR = exp(log_GFR)
  return(GFR)
}
CKD_model = Vectorize(CKD_model)

Original_CKD_model = function(Sex, Scr, Age){
  CKD_model(a=141, b_F=0.7, b_M=0.9, c_F=-0.329, c_M=-0.411, d=-1.209, e=0.993,
            f=1.018, Sex=Sex, Scr=Scr, Age=Age)
}
```


## Cockcroft Gault  [@Cockcroft1976]

\begin{equation*}
 GFR = \frac{(140-Age) \times Wt \times (1-0.15[\text{if female}])}{72\times Scr}
\end{equation*}

```{r cg, echo=FALSE, eval = F}
Cockcroft_equation_2 <- function(Age, Weight, Sex, Scr){
  GFR <-  (140-Age)*Weight*(1-0.15*(Sex=="F"))*(1/(Scr*72))
}
Cockcroft_equation_2 <- Vectorize(Cockcroft_equation_2)
```

## MDRD-186 [@Levey2006]

\begin{equation*}
GFR = 186 \times Scr^{-1.154} \times Age^{-0.203} \times 0.742 [\text{if female}]
\end{equation*}
```{r mdrd, echo=FALSE}
MDRD_equation <- function(Age, Creat, Sex, a=186, b=-1.154, c=-0.203, d=0.742){
  GFR <- a * (Creat^b) * (Age^c)
  if(Sex == "F"){
    GFR <- GFR*d
  }
  return(GFR)
}
MDRD_equation <- Vectorize(MDRD_equation)
```


## Jelliffe  [@Jelliffe1973]

\begin{equation*}
GFR = \frac{(98-0.8(Age-20))\times(1-0.1[\text{if female}])\times \frac{BSA}{1.73}}{Scr}
\end{equation*}

```{r jell, echo=FALSE}
Jelliffe_equation <- function(Age, Creat, Sex, BSA){
  GFR <- (98-0.8*(Age-20))*(1-0.1*(Sex=="F"))*(BSA/1.73)*(1/Creat)
  return(GFR)
}
Jelliffe_equation <- Vectorize(Jelliffe_equation)
```


## Wright [@Wright2001]

\begin{equation*}
GFR = \frac{(6580-38.8\times Age)\times(1-0.168[\text{if female}])\times BSA}{88.42*Scr}
\end{equation*}


```{r wright, echo=FALSE}
Wright_equation <- function(Age, Creat, Sex, BSA){
  GFR <- (6580-38.8*Age)*(1-0.168*(Sex=="F"))*BSA*(1/(Creat*88.42))
  return(GFR)
}
Wright_equation <- Vectorize(Wright_equation)
```


## Mayo Quadratic [@Rule2004]

\begin{equation*}
GFR = \exp \left(1.911 + 5.249\frac{1}{Scr} - 2.114\frac{1}{Scr^2} - 0.00686Age - 0.205 [\text{if female}]\right)
\end{equation*}
if $Scr < 0.8$mg/dL then use $0.8$ for $Scr$
```{r mayo, echo=FALSE}
Mayo_equation <- function(Age, Creat, Sex){
  if(Creat < 0.8){
    Creat = 0.8
  }
  Creat <- 1/Creat
  GFR <- exp(1.911 + 5.249*Creat - 2.114*Creat^2 -0.00686*Age - 0.205*(Sex=="F"))
  return(GFR)
}
Mayo_equation <- Vectorize(Mayo_equation)
```


## Martin [@Martin1998]

\begin{equation*}
GFR = \frac{163\times \mathrm{Wt}\ \times(1-0.00496\times \mathrm{Age})\times(1-0.252[\text{if female}])}{88.42\times \mathrm{Scr}}
\end{equation*}

```{r martin, echo=FALSE}
Martin_equation <- function(Age, Creat, Sex, Wt){
  Creat = Creat*88.4
  GFR = 163*Wt*(1-0.00496*Age)*(1-0.252*(Sex=="F"))/Creat
  return(GFR)
}
```



# References


